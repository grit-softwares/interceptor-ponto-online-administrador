<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redirecionando...</title>
    <script>
        window.onload = async () => {
            const hash = window.location.hash; // Ex: #access_token=abc123&expires_at=...
            const params = new URLSearchParams(hash.replace('#', ''));
            const token = params.get('access_token');

            if (!token) {
                window.location.replace("https://ponto-online-administrador.flutterflow.app/login");
                return;
            }

            // Consulta o backend para descobrir a role
            try {
                const resp = await fetch("https://jlgeugbqxvbvwgtfmucc.supabase.co/functions/v1/usuario-refresh-token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ refresh_token: token })
                });
                const result = await resp.json();

                const role = result.user?.role;

                if (role === "admin") {
                    window.location.replace(`https://ponto-online-administrador.flutterflow.app/recuperar-senha-step-two?k=${encodeURIComponent(token)}`);
                } else if (role === "rh") {
                    window.location.replace(`https://ponto-online-rh.flutterflow.app/recuperar-senha-step-two?k=${encodeURIComponent(token)}`);
                } else {
                    window.location.replace("https://ponto-online-administrador.flutterflow.app/login");
                }
            } catch (e) {
                window.location.replace("https://ponto-online-administrador.flutterflow.app/login");
            }
        };
    </script>
</head>
<body>
<p>Redirecionando, aguarde...</p>
</body>
</html>
